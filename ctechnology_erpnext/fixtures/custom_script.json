[
 {
  "docstatus": 0, 
  "doctype": "Custom Script", 
  "dt": "Item", 
  "modified": "2017-01-28 13:55:33.851172", 
  "name": "Item-Client", 
  "script": "frappe.ui.form.on(\"Item\", \"refresh\", async function(frm) {\n\t\n\t// item.js loads Stock Levels only for non-fixed assets\n\tif (frm.doc.is_fixed_asset)\n\t\treturn;\n\t\n\t// sleep 1.5sec..  \n\tawait sleep(1500);\n\t\n\tfrappe.after_ajax(function() {\n\t\t// custom method\n\t\tfrappe.call({\n\t\t\t\"method\" : \"ctechnology_erpnext.api.item_warehouse_valuationrate\",\n\t\t\t\n\t\t\t// takes two arguments., item and warehouse=None\n\t\t\targs : {\n\t\t\t\titem : frm.doc.name\n\t\t\t},\n\t\t\t\n\t\t\tcallback : function(data){\n\t\t\t\tif (!data.message)\n\t\t\t\t\treturn;\n\t\t\t\t\n\t\t\t\tvar _currency = frappe.defaults.get_global_default('currency');\n\t\t\t\t// simplicity?\n\t\t\t\tvar get_cost = function(warehouse){\n\t\t\t\t\t\n\t\t\t\t\t// var to hold empty/cost\n\t\t\t\t\tvar cost;\n\t\t\t\t\t$.each(data.message, function(i, obj)\n\t\t\t\t\t{\t\t\t\t\t\t\n\t\t\t\t\t\t\tif (obj.warehouse == warehouse){\n\t\t\t\t\t\t\t\tcost = obj.valuation_rate;\n\t\t\t\t\t\t\t\t// $.each breaks if returned false\n\t\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t\t// format currency read from sbkolate.com\n\t\t\t\t\treturn format_currency(cost, currency= _currency);\n\t\t\t\t};\n\t\t\t\t\n\t\t\t\t// in .form-dashboard-section.custom, child .result --- iterating each children of .result\n\t\t\t\t$('.form-dashboard-section.custom .result').children().each(function(i, obj)\n\t\t\t\t{\n\t\t\t\t\t// etching warehouse val and modifying items col and graph col\n\t\t\t\t\t// warehouse -- 1st col, items col -- 2nd col, graph - 3rd\n\t\t\t\t\t// nth-child -- 1-indexed\n\t\t\t\t\tvar warehouse = $(this).find('.row > div:nth-child(1) > a').attr('data-name');\n\t\t\t\t\t$(this).find('.row > div:nth-child(2)').addClass('col-sm-2').removeClass('col-sm-3');\n\t\t\t\t\t$(this).find('.row > div:nth-child(3)').addClass('col-sm-3').removeClass('col-sm-4');\n\t\n\t\t\t\t\t$(this).find('.row > div:nth-child(2)').after('<div class=\"col-sm-2 small\" style=\"margin-top: 8px; white-space: nowrap;\"><h6 class=\"uppercase\" style=\"display: inline;\">Cost</h6>&ensp;'+ get_cost(warehouse) +'</div>');\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t});\n});\n\nfunction sleep(ms) {\n  return new Promise(resolve => setTimeout(resolve, ms));\n}\n", 
  "script_type": "Client"
 }, 
 {
  "docstatus": 0, 
  "doctype": "Custom Script", 
  "dt": "Sales Invoice", 
  "modified": "2017-01-28 14:55:54.312533", 
  "name": "Sales Invoice-Client", 
  "script": "frappe.ui.form.on(\"Sales Invoice\", {\n\tterritory : function(frm, cdt, cdn) {\n\t\t\t\n\t\t// ref\n\t\t\tvar xdoc = frm.doc;\n\t\t\t\n\t\t\t// if territory is null, return\n\t\t\tif (!xdoc.territory || !xdoc.is_pos)\n\t\t\t\treturn;\n\t\t\t\n\t\t\tfrappe.after_ajax(function() {\n\t\t\t\tfrappe.call({\n\t\t\t\t\t'method' : 'frappe.client.get_value',\n\t\t\t\t\targs : {\n\t\t\t\t\t\tdoctype: \"Mode of Payment\",\n\t\t\t\t\t\tfilters : {\n\t\t\t\t\t\t\t\"consoleerp_territory\" : frm.doc.territory\n\t\t\t\t\t\t},\n\t\t\t\t\t\tfieldname : [\"name\", \"type\"],\n\t\t\t\t\t\tas_dict: true\n\t\t\t\t\t},\n\t\t\t\t\tcallback: function(data) {\n\t\t\t\t\t\tif (!data.message)\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t// clear payments table in Sales Invoice\n\t\t\t\t\t\txdoc.payments = [];\n\t\t\t\t\t\t// add new child; payment-- is the doc obj\n\t\t\t\t\t\tvar payment = frappe.model.add_child(xdoc, \"Sales Invoice Payment\", \"payments\");\n\t\t\t\t\t\tpayment.mode_of_payment = data.message.name;\n\t\t\t\t\t\tpayment.amount = xdoc.rounded_total;\n\t\t\t\t\t\t// set as Cash type by default\n\t\t\t\t\t\tpayment.type = data.message.type;\n\t\t\t\t\t\t\n\t\t\t\t\t\t// defined in /erpnext/public/js/controllers/accounts.js\n\t\t\t\t\t\tget_payment_mode_account(frm, data.message.name, function(account){\n\t\t\t\t\t\t\tpayment.account = account;\t\t\n\t\t\t\t\t\t\trefresh_field(\"payments\");\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t}\n});\n\t\nfrappe.ui.form.on('Sales Invoice Item', {\n\titem_code : function(frm, cdt, cdn) {\n\t\tcust_fetch_item_cost_with_warehouse(frm, cdt,cdn);\t\t\n\t},\n\twarehouse : function(frm, cdt, cdn) {\n\t\tcust_fetch_item_cost_with_warehouse(frm, cdt,cdn);\n\t}\n\n});\n\t\t\nvar cust_fetch_item_cost_with_warehouse = async function(frm, cdt, cdn) {\n\t// null val\n\tfrappe.model.set_value(cdt, cdn, \"consoleerp_cost\", null);\n\t// return if not updating stock\n\t// cur_frm -- global variable for current_form\n\tif (!cur_frm.doc.update_stock) {\n\t\tshow_alert(\"Not Updating Stock\", 1);\n\t\treturn;\n\t}\n\n\titem = frappe.model.get_value(cdt, cdn, \"item_code\");\n\twarehouse = frappe.model.get_value(cdt, cdn, \"warehouse\");\n\tif (!item || !warehouse) {\n\t\tshow_alert(\"Item or Warehouse Missing\", 3);\n\t\treturn;\t\n\t}\n\t\n\tfrappe.after_ajax(function(){\n\t\tfrappe.call({\n\t\t\t\t\"method\": \"ctechnology_erpnext.api.item_warehouse_valuationrate\",\n\t\t\t\targs: {\n\t\t\t\t\titem: item,\n\t\t\t\t\twarehouse: warehouse\n\t\t\t\t},\n\t\t\t\tcallback: function(data) {\n\t\t\t\t\tfrappe.model.set_value(cdt, cdn, \"consoleerp_cost\", data.message);\t\n\t\t\t\t}\n\t\t\t});\n\t\t});\n}\n\t\nfunction sleep(ms) {\n\treturn new Promise(resolve => setTimeout(resolve, ms));\n}\n\n", 
  "script_type": "Client"
 }
]